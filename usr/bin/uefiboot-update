#!/bin/bash
# Setup cofinuration values 
ROOT=""
OPTIONS="ro quiet"
ROOTFLAGS=""
K_SUFFIX=""
DISTRIB=$(lsb_release -i -s)
DISTRIB_ID="$(lsb_release -r -s) $(lsb_release -c -s)"
EFI_VOLUME=$(blkid -lt TYPE="vfat" -o device)

# Read the config file if it exists
if [ -e /etc/uefiboot.conf ]
then
  source /etc/uefiboot.conf
fi

# Read root mounting line from /etc/fstab
R_LINE="$(sed '/^#.*/d;/ \/ /!d' /etc/fstab)"

# If ROOT is not defined then get root partition reference from /etc/fstab
if [[ "$ROOT" = "" ]]
then
  ROOT="$(echo $R_LINE | sed 's/ \/.*//')"
fi

# If ROOTFLAGS is not defined then get subvolume id or name from /etc/fstab
if [[ "$ROOTFLAGS" = "" ]] & [[ $R_LINE == *"subvol"* ]]
then
  ROOTFLAGS="rootflags=$(echo $R_LINE | sed 's/^.*\(subvol[^ \t,]*\).*$/\1/')"
fi

# Remove all Ubuntu boot options from UEFI.
for OPT in $(efibootmgr | sed "/Boot[0-9].*$DISTRIB/!d;s/Boot//;s/\*.*//")
do
  efibootmgr -Bb$OPT >/dev/null
done

# Add new boot options according to installed kernels.
echo "Updating UEFI boot options"
# Sort kernel version from older (first) to latest (last). It is imoprtant
# as last added options will be first option in booting order.
for KVER in $(ls /boot/vmlinuz*generic | sed 's/\/boot\/vmlinuz-//' | sort -r)
do
  echo -n "Kernel vmlinuz-$KVER found"
  efibootmgr --create --disk $(expr "$EFI_VOLUME" : '\([^0-9]*\)') --part $(expr "$EFI_VOLUME" : '.*\([0-9]\)') --loader vmlinuz-$KVER$K_SUFFIX --label "$DISTRIB $DISTRIB_ID $KVER" -u "root=$ROOT $ROOTFLAGS $OPTIONS initrd=initrd.img-$KVER" >/dev/null
  echo " ... added"
done
